<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>nvim-web Firefox Diagnostics</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #0f0; padding: 20px; }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .warn { color: #ff0; }
        #log { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>nvim-web Firefox Diagnostics</h1>
    <div id="log"></div>
    <script type="module">
        const log = document.getElementById('log');
        function print(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            log.appendChild(div);
        }

        async function runDiagnostics() {
            print('Starting diagnostics...\n');

            // 1. Check WebSocket support
            print('1. WebSocket support: ' + (typeof WebSocket !== 'undefined' ? 'PASS' : 'FAIL'), 
                  typeof WebSocket !== 'undefined' ? 'pass' : 'fail');

            // 2. Check WebAssembly support
            print('2. WebAssembly support: ' + (typeof WebAssembly !== 'undefined' ? 'PASS' : 'FAIL'),
                  typeof WebAssembly !== 'undefined' ? 'pass' : 'fail');

            // 3. Check localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                print('3. localStorage access: PASS', 'pass');
            } catch (e) {
                print('3. localStorage access: FAIL - ' + e.message, 'fail');
            }

            // 4. Check import.meta support
            print('4. ES Modules (import.meta): ' + (typeof import.meta !== 'undefined' ? 'PASS' : 'FAIL'),
                  typeof import.meta !== 'undefined' ? 'pass' : 'fail');

            // 5. Try loading WASM
            print('\n5. Loading WASM module...');
            try {
                const response = await fetch('/pkg/nvim_web_ui_bg.wasm');
                print('   - Fetch status: ' + response.status, response.ok ? 'pass' : 'fail');
                print('   - Content-Type: ' + response.headers.get('Content-Type'));
                
                const bytes = await response.arrayBuffer();
                print('   - Downloaded: ' + bytes.byteLength + ' bytes', 'pass');
                
                const compiled = await WebAssembly.compile(bytes);
                print('   - WASM compiled: PASS', 'pass');
            } catch (e) {
                print('   - WASM error: ' + e.message, 'fail');
            }

            // 6. Test WebSocket connection
            print('\n6. Testing WebSocket connection...');
            try {
                const ws = new WebSocket('ws://127.0.0.1:9001?session=new');
                ws.binaryType = 'arraybuffer';
                
                await new Promise((resolve, reject) => {
                    ws.onopen = () => {
                        print('   - WebSocket connected: PASS', 'pass');
                        resolve();
                    };
                    ws.onerror = (e) => {
                        print('   - WebSocket error', 'fail');
                        reject(e);
                    };
                    setTimeout(() => reject(new Error('timeout')), 5000);
                });

                // Wait for first message
                await new Promise((resolve) => {
                    ws.onmessage = (e) => {
                        print('   - Received message: ' + e.data.byteLength + ' bytes', 'pass');
                        resolve();
                    };
                    setTimeout(resolve, 2000);
                });

                ws.close();
                print('   - WebSocket closed cleanly', 'pass');
            } catch (e) {
                print('   - WebSocket test failed: ' + e.message, 'fail');
            }

            // 7. Check Canvas 2D context
            print('\n7. Testing Canvas...');
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.font = '14px monospace';
                    const metrics = ctx.measureText('M');
                    print('   - Canvas 2D context: PASS', 'pass');
                    print('   - measureText width: ' + metrics.width.toFixed(2));
                    print('   - actualBoundingBoxAscent: ' + (metrics.actualBoundingBoxAscent || 'undefined'));
                    print('   - actualBoundingBoxDescent: ' + (metrics.actualBoundingBoxDescent || 'undefined'));
                } else {
                    print('   - Canvas 2D context: FAIL', 'fail');
                }
            } catch (e) {
                print('   - Canvas error: ' + e.message, 'fail');
            }

            print('\n\nDiagnostics complete. Please share this output.');
        }

        runDiagnostics();
    </script>
</body>
</html>
