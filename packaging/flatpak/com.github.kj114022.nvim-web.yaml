app-id: com.github.kj114022.nvim-web
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: nvim-web

finish-args:
  # Network access for WebSocket/WebTransport
  - --share=network
  # X11/Wayland display (for browser launching)
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # Filesystem access
  - --filesystem=home
  - --filesystem=/tmp
  # Talk to portals
  - --talk-name=org.freedesktop.portal.*

modules:
  # Neovim dependency
  - name: neovim
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/neovim/neovim/archive/refs/tags/v0.10.0.tar.gz
        sha256: PLACEHOLDER_SHA256

  # nvim-web binary
  - name: nvim-web
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/nvim-web/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release -p nvim-web-host --verbose
      - install -Dm755 target/release/nvim-web-host /app/bin/nvim-web
      - install -Dm644 config.example.toml /app/etc/nvim-web/config.example.toml
    sources:
      - type: archive
        url: https://github.com/kj114022/nvim-web/archive/refs/tags/v0.1.0.tar.gz
        sha256: PLACEHOLDER_SHA256
      # Cargo sources would be generated by flatpak-cargo-generator.py
      - cargo-sources.json
