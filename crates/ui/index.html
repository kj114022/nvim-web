<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#16161d">
  <meta name="description" content="Neovim in the Browser - Terminal-native experience">
  <title>nvim-web</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="nvim-web">
  <script src="/config.js"></script>
  <!-- xterm.js for terminal panel -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
</head>
<body>
  <!-- Shell Layout -->
  <div id="nvim-shell">
    <!-- Header Bar -->
    <header id="nvim-header">
      <div class="header-left">
        <span class="logo">nvim-web</span>
        <button id="btn-file-tree" class="header-btn" title="Toggle File Tree (Ctrl+B)">â˜°</button>
      </div>
      <div class="header-center">
        <div id="buffer-tabs" class="buffer-tabs">
          <!-- Buffer tabs populated by JS -->
        </div>
      </div>
      <div class="header-actions">
        <button id="btn-terminal" class="header-btn" title="Toggle Terminal (Ctrl+`)">âŒ¨</button>
        <button id="btn-settings" class="header-btn" title="Settings">âš™</button>
        <button id="btn-zen" class="header-btn" title="Zen Mode (hide UI)">â—¯</button>
      </div>
    </header>

    <!-- Main Content Area -->
    <main id="nvim-main">
      <!-- Left Panel: File Tree -->
      <aside id="panel-left" class="panel-left">
        <div class="panel-header">
          <span>Explorer</span>
          <button class="panel-close" data-panel="left">Ã—</button>
        </div>
        <div id="file-tree" class="panel-content">
          <div class="tree-empty">No folder open</div>
        </div>
      </aside>
      
      <!-- Center: Neovim Canvas -->
      <section id="panel-center">
        <div id="nvim-container">
          <div id="nvim-images"></div>
          <canvas id="grid-canvas"></canvas>
        </div>
      </section>
      
      <!-- Right Panel: AI Assistant -->
      <aside id="panel-right" class="panel-right">
        <div class="panel-header">
          <span>ğŸ¤– AI Assistant</span>
          <button class="panel-close" data-panel="right">Ã—</button>
        </div>
        <div class="panel-content llm-panel">
          <!-- Provider selector -->
          <div class="llm-provider-row">
            <select id="llm-provider" class="llm-provider-select">
              <option value="gemini">Gemini</option>
              <option value="claude">Claude</option>
              <option value="custom">Ollama</option>
            </select>
            <button id="llm-settings-btn" class="llm-settings-btn" title="Configure API Key">âš™ï¸</button>
          </div>
          
          <!-- Output area -->
          <div id="llm-output" class="llm-output">
            <div class="llm-welcome">
              <p>Ask questions about your code or get AI assistance.</p>
              <p class="llm-hint">Tip: Select code before asking to provide context.</p>
            </div>
          </div>
          
          <!-- Input area -->
          <div class="llm-input-area">
            <textarea id="llm-prompt" class="llm-prompt" placeholder="Ask anything..." rows="2"></textarea>
            <button id="llm-send" class="llm-send-btn">Send</button>
          </div>
        </div>
      </aside>
    </main>

    <!-- Bottom Panel: Terminal -->
    <footer id="panel-bottom" class="panel-bottom">
      <div class="panel-header">
        <span>Terminal</span>
        <button class="panel-close" data-panel="bottom">Ã—</button>
      </div>
      <div id="terminal-container" class="panel-content">
        <!-- xterm.js will mount here -->
      </div>
    </footer>

    <!-- P2P Chat Panel -->
    <div id="chat-panel" class="chat-panel collapsed">
      <div id="chat-header" class="chat-header">
        <span>Chat</span>
        <span id="peer-count" class="chat-badge">0 peers</span>
      </div>
      <div id="chat-messages" class="chat-messages"></div>
      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="Type a message..." />
        <button id="chat-send">Send</button>
      </div>
    </div>


    <!-- Status Bar -->
    <div id="nvim-statusbar">
      <div class="status-left">
        <span id="mode-badge" class="mode-badge mode-normal">Normal</span>
        <span id="git-branch" class="git-branch" style="display:none;">main</span>
        <span id="file-path" class="file-info"></span>
      </div>
      <div class="status-right">
        <span id="file-type" class="file-info"></span>
        <span id="cursor-pos" class="cursor-pos">1:1</span>
        <span id="connection-dot" class="connection-dot connecting" title="Connecting..."></span>
      </div>
    </div>
  </div>

  <!-- Start Screen (first visit only shows full banner) -->
  <div id="start-screen" class="start-screen">
    <pre id="ascii-banner" class="ascii-banner">
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                                                                 â”‚
â”‚   â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â”‚
â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â”‚   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â”‚   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â”‚   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â”‚   â•šâ•â•  â•šâ•â•â•â•  â•šâ•â•â•â•  â•šâ•â•â•šâ•â•     â•šâ•â•     â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â• â”‚
â”‚                                                                 â”‚
â”‚                    Neovim in the Browser                        â”‚
â”‚                                                                 â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    </pre>
    
    <div class="start-menu">
      <div class="start-menu-header">Quick Actions</div>
      
      <div class="start-shortcuts">
        <div class="start-shortcut" id="action-new" tabindex="0">
          <span class="shortcut-key">n</span>
          <span class="shortcut-label">New session</span>
        </div>
        <div class="start-shortcut" id="action-open" tabindex="0">
          <span class="shortcut-key">o</span>
          <span class="shortcut-label">Open folder</span>
        </div>
        <div class="start-shortcut" id="action-resume" tabindex="0">
          <span class="shortcut-key">r</span>
          <span class="shortcut-label">Resume last</span>
        </div>
        <div class="start-shortcut" id="action-help" tabindex="0">
          <span class="shortcut-key">?</span>
          <span class="shortcut-label">Help / Tutorial</span>
        </div>
      </div>
      
      <div class="recent-section">
        <div class="recent-header">Recent Files</div>
        <ul id="recent-files-list" class="recent-list">
          <li class="recent-empty">No recent files</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="nvim-toast"></div>

  <!-- Connection Lost Overlay -->
  <div id="connection-indicator" style="display:none;">Connection Lost</div>

  <!-- Offline Indicator -->
  <div id="offline-indicator" style="display:none;">Offline Mode</div>

  <!-- Hidden IME Input -->
  <textarea id="nvim-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
  
  <!-- IME Composition Preview -->
  <div id="ime-preview" class="ime-preview"></div>

  <!-- Hidden File Picker -->
  <input type="file" id="file-picker" style="display:none;" />

  <!-- Learning Mode Hints (opt-in, toggle with F1) -->
  <div id="hints-panel" class="hints-panel">
    <div class="hints-header">Normal Mode</div>
    <div class="hint-row"><span class="hint-key">i</span><span class="hint-desc">insert before</span></div>
    <div class="hint-row"><span class="hint-key">a</span><span class="hint-desc">insert after</span></div>
    <div class="hint-row"><span class="hint-key">dd</span><span class="hint-desc">delete line</span></div>
    <div class="hint-row"><span class="hint-key">:w</span><span class="hint-desc">save file</span></div>
    <div class="hint-row"><span class="hint-key">:q</span><span class="hint-desc">quit</span></div>
    <div class="hint-row"><span class="hint-key">:e</span><span class="hint-desc">open file</span></div>
    <div class="hint-row"><span class="hint-key">/</span><span class="hint-desc">search</span></div>
  </div>

  <!-- Settings Panel (opt-in) -->
  <div id="settings-panel" class="settings-panel">
    <div class="settings-header">
      <span>Settings</span>
      <button id="settings-close" class="panel-close">Ã—</button>
    </div>
    <div class="settings-content">
      <div class="setting-row">
        <label for="setting-theme">Color Theme</label>
        <select id="setting-theme">
          <option value="kanagawa" selected>Kanagawa</option>
          <option value="dracula">Dracula</option>
          <option value="nord">Nord</option>
        </select>
      </div>
      <div class="setting-row">
        <label for="setting-gpu">GPU Acceleration</label>
        <input type="checkbox" id="setting-gpu" checked>
      </div>
      <div class="setting-row">
        <label for="setting-hints">Show Hints (F1)</label>
        <input type="checkbox" id="setting-hints">
      </div>
    </div>
  </div>

  <!-- WASM Module -->
  <script type="module">
    import init from './pkg/nvim_web_ui.js';

    // WebTerminal class - wraps xterm.js and communicates with host
    class WebTerminal {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        if (!this.container || !window.Terminal) {
          console.error('[WebTerminal] Missing container or xterm.js');
          return;
        }

        // Initialize xterm.js with Kanagawa theme
        this.term = new Terminal({
          theme: {
            background: '#16161d',
            foreground: '#dcd7ba',
            cursor: '#dcd7ba',
            cursorAccent: '#16161d',
            selection: 'rgba(126, 156, 216, 0.3)',
            black: '#16161d',
            red: '#e46876',
            green: '#98bb6c',
            yellow: '#e6c384',
            blue: '#7e9cd8',
            magenta: '#957fb8',
            cyan: '#7fb4ca',
            white: '#dcd7ba',
            brightBlack: '#727169',
            brightRed: '#e46876',
            brightGreen: '#98bb6c',
            brightYellow: '#e6c384',
            brightBlue: '#7e9cd8',
            brightMagenta: '#957fb8',
            brightCyan: '#7fb4ca',
            brightWhite: '#dcd7ba',
          },
          fontFamily: 'JetBrains Mono, monospace',
          fontSize: 14,
          cursorBlink: true,
        });

        // Use fit addon to resize terminal
        this.fitAddon = new FitAddon.FitAddon();
        this.term.loadAddon(this.fitAddon);
        
        this.term.open(this.container);
        this.fitAddon.fit();
        
        // Resize on window resize
        window.addEventListener('resize', () => this.fitAddon.fit());
        
        // Connect to WebSocket for terminal I/O
        this.connectTerminal();
        
        // Handle input from user
        this.term.onData(data => {
          this.sendInput(data);
        });
        
        console.log('[WebTerminal] Initialized');
      }

      connectTerminal() {
        // Terminal will be connected to host via the existing WASM bridge
        // For now, print a welcome message
        this.term.writeln('\\x1b[1;36m$ Welcome to nvim-web terminal\\x1b[0m');
        this.term.writeln('\\x1b[90mTerminal integration ready. Backend: portable-pty\\x1b[0m');
        this.term.writeln('');
        
        // Expose this instance globally for WASM to call
        window.nvimWebTerminal = this;
      }

      sendInput(data) {
        // This will be called by xterm.js when user types
        // Forward to WASM module which sends to host via WebSocket
        if (window.nvimWebSendTerminalInput) {
          window.nvimWebSendTerminalInput(data);
        }
      }

      write(data) {
        // Called by WASM when receiving terminal_output from host
        if (this.term) {
          this.term.write(data);
        }
      }

      resize(cols, rows) {
        if (this.term) {
          this.term.resize(cols, rows);
        }
      }

      dispose() {
        if (this.term) {
          this.term.dispose();
          this.term = null;
        }
      }
    }

    // Make WebTerminal available globally
    window.WebTerminal = WebTerminal;

    // First visit detection - hide ASCII banner on subsequent visits
    const isFirstVisit = !localStorage.getItem('nvim-web-visited');
    if (!isFirstVisit) {
      const banner = document.getElementById('ascii-banner');
      if (banner) banner.style.display = 'none';
    }
    localStorage.setItem('nvim-web-visited', 'true');

    // Panel toggle handlers
    const togglePanel = (panelId) => {
      const panel = document.getElementById(panelId);
      panel?.classList.toggle('expanded');
    };

    document.getElementById('btn-file-tree')?.addEventListener('click', () => togglePanel('panel-left'));
    
    // Terminal toggle - initialize terminal on first open
    let webTerminal = null;
    document.getElementById('btn-terminal')?.addEventListener('click', () => {
      togglePanel('panel-bottom');
      const panel = document.getElementById('panel-bottom');
      if (panel?.classList.contains('expanded') && !webTerminal) {
        webTerminal = new WebTerminal('terminal-container');
      }
    });
    
    // Close buttons
    document.querySelectorAll('.panel-close').forEach(btn => {
      btn.addEventListener('click', () => {
        const panelId = `panel-${btn.dataset.panel}`;
        document.getElementById(panelId)?.classList.remove('expanded');
      });
    });

    // Zen mode
    document.getElementById('btn-zen')?.addEventListener('click', () => {
      document.getElementById('nvim-header')?.classList.toggle('hidden');
      document.getElementById('nvim-statusbar')?.classList.toggle('hidden');
    });

    // Settings panel
    document.getElementById('btn-settings')?.addEventListener('click', () => {
      document.getElementById('settings-panel')?.classList.toggle('visible');
    });
    document.getElementById('settings-close')?.addEventListener('click', () => {
      document.getElementById('settings-panel')?.classList.remove('visible');
    });

    // Theme switcher
    document.getElementById('setting-theme')?.addEventListener('change', (e) => {
      document.body.dataset.theme = e.target.value;
      localStorage.setItem('nvim-web-theme', e.target.value);
    });
    // Load saved theme
    const savedTheme = localStorage.getItem('nvim-web-theme');
    if (savedTheme) {
      document.body.dataset.theme = savedTheme;
      const select = document.getElementById('setting-theme');
      if (select) select.value = savedTheme;
    }

    // GPU toggle
    document.getElementById('setting-gpu')?.addEventListener('change', (e) => {
      localStorage.setItem('nvim-web-gpu-disabled', e.target.checked ? 'false' : 'true');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+B: Toggle file tree
      if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        togglePanel('panel-left');
      }
      // Ctrl+`: Toggle terminal
      if (e.ctrlKey && e.key === '`') {
        e.preventDefault();
        togglePanel('panel-bottom');
      }
      // F1: Toggle hints
      if (e.key === 'F1') {
        e.preventDefault();
        document.getElementById('hints-panel')?.classList.toggle('visible');
      }
      // Escape: Close panels/settings
      if (e.key === 'Escape') {
        document.getElementById('settings-panel')?.classList.remove('visible');
      }
    });

    // Start screen keyboard navigation
    document.addEventListener('keydown', (e) => {
      const startScreen = document.getElementById('start-screen');
      if (!startScreen || startScreen.classList.contains('hidden')) return;
      
      switch(e.key.toLowerCase()) {
        case 'n':
          document.getElementById('action-new')?.click();
          break;
        case 'o':
          document.getElementById('action-open')?.click();
          break;
        case 'r':
          document.getElementById('action-resume')?.click();
          break;
        case '?':
          document.getElementById('action-help')?.click();
          break;
        case 'escape':
          startScreen.classList.add('hidden');
          break;
      }
    });

    // Click handlers for start screen
    document.getElementById('action-new')?.addEventListener('click', () => {
      document.getElementById('start-screen')?.classList.add('hidden');
    });

    document.getElementById('action-open')?.addEventListener('click', () => {
      document.getElementById('file-picker')?.click();
    });

    document.getElementById('action-resume')?.addEventListener('click', () => {
      document.getElementById('start-screen')?.classList.add('hidden');
    });

    // Initialize WASM
    init().catch(console.error);
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(reg => console.log('[SW] Registered:', reg.scope))
        .catch(err => console.error('[SW] Registration failed:', err));
    }
    
    // Offline indicator
    const offlineEl = document.getElementById('offline-indicator');
    window.addEventListener('online', () => offlineEl.style.display = 'none');
    window.addEventListener('offline', () => offlineEl.style.display = 'block');
    if (!navigator.onLine) offlineEl.style.display = 'block';
    
    // LLM Panel handlers
    (function initLlmPanel() {
      const sendBtn = document.getElementById('llm-send');
      const promptEl = document.getElementById('llm-prompt');
      const outputEl = document.getElementById('llm-output');
      const providerEl = document.getElementById('llm-provider');
      const settingsBtn = document.getElementById('llm-settings-btn');
      
      if (!sendBtn || !promptEl) return;
      
      // Send prompt
      sendBtn.addEventListener('click', () => {
        const prompt = promptEl.value.trim();
        if (!prompt) return;
        
        // Clear welcome message
        const welcome = outputEl.querySelector('.llm-welcome');
        if (welcome) welcome.remove();
        
        // Add user message
        const userMsg = document.createElement('div');
        userMsg.className = 'llm-message user';
        userMsg.textContent = prompt;
        outputEl.appendChild(userMsg);
        
        // Add assistant message (streaming target)
        const assistantMsg = document.createElement('div');
        assistantMsg.className = 'llm-message assistant streaming';
        assistantMsg.id = 'llm-current-response';
        outputEl.appendChild(assistantMsg);
        
        // Scroll to bottom
        outputEl.scrollTop = outputEl.scrollHeight;
        
        // Clear input
        promptEl.value = '';
        sendBtn.disabled = true;
        
        // Send to backend via WASM bridge (when available)
        if (window.nvimWebLlm) {
          window.nvimWebLlm.prompt(prompt, providerEl.value);
        } else {
          // Demo mode
          assistantMsg.textContent = '(LLM backend not connected. Backend handlers ready.)';
          assistantMsg.classList.remove('streaming');
          sendBtn.disabled = false;
        }
      });
      
      // Enter to send
      promptEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });
      
      // Settings button
      settingsBtn.addEventListener('click', () => {
        const provider = providerEl.value;
        const key = window.prompt(`Enter API key for ${provider}:`);
        if (key) {
          if (window.nvimWebLlm) {
            window.nvimWebLlm.setKey(provider, key);
          }
          alert(`API key saved for ${provider}`);
        }
      });
      
      // Expose for WASM
      window.nvimWebLlm = window.nvimWebLlm || {
        appendChunk: (text) => {
          const el = document.getElementById('llm-current-response');
          if (el) el.textContent += text;
          outputEl.scrollTop = outputEl.scrollHeight;
        },
        done: () => {
          const el = document.getElementById('llm-current-response');
          if (el) {
            el.classList.remove('streaming');
            el.removeAttribute('id');
          }
          sendBtn.disabled = false;
        }
      };
    })();
  </script>
</body>
</html>